<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chemistry Formula Practice</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 980px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      padding: 40px;
    }
    h1 {
      color: #11998e;
      text-align: center;
      margin-bottom: 10px;
      font-size: 2.5em;
    }
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 20px;
      font-size: 1.1em;
    }
    .stats-bar {
      display: flex;
      justify-content: space-around;
      background: #f0fff4;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .stat-item { text-align: center; }
    .stat-label { font-size: 0.9em; color: #666; margin-bottom: 5px; }
    .stat-value { font-size: 1.5em; color: #11998e; font-weight: 700; }
    .timer { color: #38ef7d; }

    .mode-buttons, .practice-buttons {
      text-align: center;
      margin-bottom: 16px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .controls-row {
      display: flex;
      gap: 20px;
      margin-bottom: 18px;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
    }
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 220px;
    }
    .control-group label {
      font-size: 0.95em;
      color: #333;
      font-weight: 600;
    }
    select {
      padding: 10px 15px;
      font-size: 1em;
      border: 2px solid #11998e;
      border-radius: 8px;
      background: white;
      cursor: pointer;
    }
    select:focus { outline: none; border-color: #38ef7d; }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
    }
    .checkbox-group input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
    .checkbox-group label { font-size: 1em; cursor: pointer; }

    button {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
      border: none;
      padding: 12px 26px;
      font-size: 1em;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      font-weight: 600;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(17,153,142,0.4); }
    button:active { transform: translateY(0); }
    button.secondary { background: #6c757d; }
    button:disabled { opacity: 0.55; cursor: not-allowed; transform: none; box-shadow: none; }
    button.evil {
      background: linear-gradient(135deg, #8B0000 0%, #FF0000 100%);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%,100% { box-shadow: 0 0 10px rgba(139,0,0,0.5); }
      50% { box-shadow: 0 0 20px rgba(255,0,0,0.8); }
    }

    .questions-container { margin-top: 22px; display: none; }
    .question {
      background: #f8f9fa;
      padding: 20px;
      margin-bottom: 18px;
      border-radius: 10px;
      border-left: 4px solid #11998e;
      position: relative;
    }
    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
      gap: 10px;
    }
    .question-text { font-size: 1.08em; color: #333; font-weight: 500; flex: 1; }
    .chemical-formula {
      font-family: 'Courier New', monospace;
      font-size: 1.18em;
      background: white;
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      overflow-x: auto;
    }
    .hint-button {
      padding: 6px 12px;
      font-size: 0.85em;
      margin: 0;
      background: #ffc107;
      color: #333;
      white-space: nowrap;
    }
    .hint-box {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 12px;
      border-radius: 6px;
      margin-top: 10px;
      display: none;
    }
    .hint-box.show { display: block; }
    .hint-box strong { color: #856404; }

    .answer-input {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    input[type="number"], input[type="text"] {
      padding: 10px;
      font-size: 1em;
      border: 2px solid #ddd;
      border-radius: 6px;
    }
    input[type="number"] { width: 120px; }
    input[type="text"] { width: 260px; }
    input:focus { outline: none; border-color: #11998e; }

    .coefficient-input { display: flex; align-items: center; gap: 6px; flex-wrap: nowrap; }
    .coefficient-input input[type="number"] { width: 72px; }

    .feedback {
      margin-top: 10px;
      padding: 8px 12px;
      border-radius: 5px;
      font-weight: 650;
      display: none;
    }
    .feedback.correct {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }
    .feedback.incorrect {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }

    .button-container { text-align: center; margin-top: 22px; }
    .score-container {
      text-align: center;
      margin-top: 18px;
      padding: 20px;
      background: #e7f3ff;
      border-radius: 10px;
      display: none;
    }
    .score-container h2 { color: #11998e; margin-bottom: 10px; }
    .score { font-size: 2em; color: #38ef7d; font-weight: 800; }

    .note {
      text-align:center;
      color:#666;
      font-size:0.92em;
      margin-top:8px;
    }

    @media (max-width: 700px) {
      .container { padding: 20px; }
      h1 { font-size: 2em; }
      .control-group { min-width: 100%; }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Chemistry Formula Practice</h1>
    <p class="subtitle">Stoichiometry â€¢ Balancing â€¢ Reaction Types â€¢ Molar Mass â€¢ Counting Atoms</p>

    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-label">Questions Today</div>
        <div class="stat-value" id="questionsToday">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Correct Today</div>
        <div class="stat-value" id="correctToday">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Accuracy</div>
        <div class="stat-value" id="accuracy">0%</div>
      </div>
      <div class="stat-item" id="timerDisplay" style="display:none;">
        <div class="stat-label">Time Elapsed</div>
        <div class="stat-value timer" id="timerValue">0:00</div>
      </div>
    </div>

    <div class="mode-buttons">
      <button id="stoichBtn" onclick="switchQuestionMode('stoichiometry')">Stoichiometry</button>
      <button id="balanceBtn" class="secondary" onclick="switchQuestionMode('balancing')">Balancing Equations</button>
      <button id="reactionBtn" class="secondary" onclick="switchQuestionMode('reaction')">Reaction Types</button>
      <button id="molarMassBtn" class="secondary" onclick="switchQuestionMode('molarMass')">Molar Mass</button>
      <button id="atomsBtn" class="secondary" onclick="switchQuestionMode('atoms')">Counting Atoms</button>
    </div>

    <div class="practice-buttons">
      <button id="practiceModeBtn" onclick="switchPracticeMode('practice')">Practice (5 Questions)</button>
      <button id="worksheetModeBtn" class="secondary" onclick="switchPracticeMode('worksheet')">Worksheet (10 Questions)</button>
    </div>

    <div class="controls-row">
      <div class="control-group">
        <label for="difficulty">Difficulty Level:</label>
        <select id="difficulty">
          <option value="easy">Easy</option>
          <option value="medium" selected>Medium</option>
          <option value="hard">Hard</option>
          <option value="evil">ðŸ˜ˆ EVIL MODE ðŸ˜ˆ</option>
        </select>
      </div>

      <div class="control-group" id="equationSourceControl">
        <label for="equationSource">Equation Source:</label>
        <select id="equationSource">
          <option value="common" selected>Curated Reactions</option>
        </select>
      </div>

      <div class="checkbox-group">
        <input type="checkbox" id="timerToggle">
        <label for="timerToggle">Enable Timer (Practice only)</label>
      </div>
    </div>

    <div class="button-container">
      <button id="generateBtn" onclick="generateQuestions()">Generate 5 Questions</button>
      <div class="note" id="difficultyNote"></div>
    </div>

    <div class="questions-container" id="questionsContainer"></div>

    <div class="button-container" id="checkBtnContainer" style="display:none;">
      <button id="checkBtn" onclick="checkAnswers()">Check Answers</button>
      <button onclick="generateQuestions()">Try New Questions</button>
      <button class="secondary" onclick="resetStats()">Reset Stats</button>
    </div>

    <div class="score-container" id="scoreContainer">
      <h2>Your Score</h2>
      <div class="score" id="score"></div>
    </div>
  </div>

<script>
let currentQuestions = [];
let questionMode = 'stoichiometry';
let practiceMode = 'practice';
let timerInterval = null;
let timerSeconds = 0;
let stats = { questionsToday: 0, correctToday: 0 };

function getDifficultyProfile() {
  const d = document.getElementById('difficulty').value;

  if (d === 'easy') {
    return { key:'easy', molesMax: 6, molesDecimals: 0, mmDecimals: 1, mmTolerance: 0.15,
      atomAskTotalChance: 0.15, atomMaxMultiplier: 2, reactionPools: ['easy'], formulaPool: 'easy' };
  }
  if (d === 'medium') {
    return { key:'medium', molesMax: 14, molesDecimals: 1, mmDecimals: 2, mmTolerance: 0.20,
      atomAskTotalChance: 0.30, atomMaxMultiplier: 3, reactionPools: ['easy','medium'], formulaPool: 'medium' };
  }
  if (d === 'hard') {
    return { key:'hard', molesMax: 28, molesDecimals: 2, mmDecimals: 2, mmTolerance: 0.25,
      atomAskTotalChance: 0.55, atomMaxMultiplier: 5, reactionPools: ['medium','hard'], formulaPool: 'hard' };
  }
  return { key:'evil', molesMax: 60, molesDecimals: 3, mmDecimals: 2, mmTolerance: 0.30,
    atomAskTotalChance: 0.80, atomMaxMultiplier: 8, reactionPools: ['hard','evil'], formulaPool: 'evil' };
}

function updateDifficultyNote() {
  const msgByMode = {
    stoichiometry: 'Difficulty scales: larger numbers + more decimal precision.',
    balancing: 'Difficulty scales: more complex equations + larger coefficients.',
    reaction: 'Difficulty scales: more complex equations + reaction-type ambiguity.',
    molarMass: 'Difficulty scales: larger formulas + parentheses groups.',
    atoms: 'Difficulty scales: parentheses groups + total-atoms + multipliers.'
  };
  document.getElementById('difficultyNote').textContent = msgByMode[questionMode] || '';
}

document.getElementById('difficulty').addEventListener('change', () => {
  updateDifficultyNote();
  clearQuestions();
});

const atomicMasses = {
  H: 1.008, He: 4.0026, C: 12.01, N: 14.01, O: 16.00, F: 19.00, Ne: 20.18,
  Na: 22.99, Mg: 24.31, Al: 26.98, Si: 28.09, P: 30.97, S: 32.06, Cl: 35.45, Ar: 39.95,
  K: 39.10, Ca: 40.08, Fe: 55.85, Cu: 63.55, Zn: 65.38, Ag: 107.87, Ba: 137.33
};

const reactionPools = {
  easy: [
    { reactants: ['2H2','O2'], products: ['2H2O'], type: 'synthesis' },
    { reactants: ['CH4','2O2'], products: ['CO2','2H2O'], type: 'combustion' },
    { reactants: ['2Na','Cl2'], products: ['2NaCl'], type: 'synthesis' },
    { reactants: ['Zn','2HCl'], products: ['ZnCl2','H2'], type: 'single replacement' },
    { reactants: ['HCl','NaOH'], products: ['NaCl','H2O'], type: 'double replacement' }
  ],
  medium: [
    { reactants: ['2KClO3'], products: ['2KCl','3O2'], type: 'decomposition' },
    { reactants: ['2Al','3Cl2'], products: ['2AlCl3'], type: 'synthesis' },
    { reactants: ['BaCl2','Na2SO4'], products: ['2NaCl','BaSO4'], type: 'double replacement' },
    { reactants: ['C3H8','5O2'], products: ['3CO2','4H2O'], type: 'combustion' },
    { reactants: ['Cu','2AgNO3'], products: ['Cu(NO3)2','2Ag'], type: 'single replacement' }
  ],
  hard: [
    { reactants: ['Fe2O3','3CO'], products: ['2Fe','3CO2'], type: 'single replacement' },
    { reactants: ['2Na3PO4','3CaCl2'], products: ['Ca3(PO4)2','6NaCl'], type: 'double replacement' },
    { reactants: ['2Al(OH)3'], products: ['Al2O3','3H2O'], type: 'decomposition' },
    { reactants: ['2C2H6','7O2'], products: ['4CO2','6H2O'], type: 'combustion' },
    { reactants: ['FeCl3','3NaOH'], products: ['Fe(OH)3','3NaCl'], type: 'double replacement' }
  ],
  evil: [
    { reactants: ['2Fe2(SO4)3','6H2O'], products: ['4Fe(OH)3','6H2SO4'], type: 'double replacement' },
    { reactants: ['(NH4)2Cr2O7'], products: ['Cr2O3','N2','4H2O'], type: 'decomposition' },
    { reactants: ['2Al','3CuSO4'], products: ['Al2(SO4)3','3Cu'], type: 'single replacement' },
    { reactants: ['CaCO3','2HCl'], products: ['CaCl2','H2O','CO2'], type: 'double replacement' },
    { reactants: ['4NH3','5O2'], products: ['4NO','6H2O'], type: 'combustion' }
  ]
};

const formulaPools = {
  easy: ["H2O","CO2","NaCl","NH3","CH4","O2","H2","Cl2"],
  medium: ["MgCl2","CaCO3","Na2SO4","Al2O3","C2H6","KClO3","AgNO3"],
  hard: ["Ca(OH)2","(NH4)2SO4","Al2(SO4)3","Mg(NO3)2","FeCl3","CuSO4","Na3PO4"],
  evil: ["Fe2(SO4)3","Ca3(PO4)2","(NH4)2Cr2O7","Al(NO3)3","Cu(NO3)2","Fe(OH)3"]
};

function setActiveButton(activeId, allIds) {
  allIds.forEach(id => {
    const b = document.getElementById(id);
    if (!b) return;
    b.classList.remove('secondary','evil');
    if (id !== activeId) b.classList.add('secondary');
  });
  const active = document.getElementById(activeId);
  if (active) active.classList.remove('secondary');
}

function formatFormulaHTML(s) {
  return String(s).replace(/([A-Za-z\)])(\d+)/g, '$1<sub>$2</sub>');
}
function formatEquationHTML(eq) { return formatFormulaHTML(eq); }
function escapeHtml(str) {
  return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
    .replaceAll('"','&quot;').replaceAll("'","&#39;");
}

function switchQuestionMode(mode) {
  questionMode = mode;
  const id = mode === 'stoichiometry' ? 'stoichBtn' :
             mode === 'balancing' ? 'balanceBtn' :
             mode === 'reaction' ? 'reactionBtn' :
             mode === 'molarMass' ? 'molarMassBtn' : 'atomsBtn';
  setActiveButton(id, ['stoichBtn','balanceBtn','reactionBtn','molarMassBtn','atomsBtn']);
  document.getElementById('equationSourceControl').style.display = (mode === 'molarMass' || mode === 'atoms') ? 'none' : 'flex';
  updateDifficultyNote();
  clearQuestions();
}

function switchPracticeMode(mode) {
  practiceMode = mode;
  setActiveButton(mode === 'practice' ? 'practiceModeBtn' : 'worksheetModeBtn', ['practiceModeBtn','worksheetModeBtn']);
  document.getElementById('generateBtn').textContent = (mode === 'practice') ? 'Generate 5 Questions' : 'Generate 10 Questions';
  clearQuestions();
}

function clearQuestions() {
  document.getElementById('questionsContainer').innerHTML = '';
  document.getElementById('questionsContainer').style.display = 'none';
  document.getElementById('checkBtnContainer').style.display = 'none';
  document.getElementById('scoreContainer').style.display = 'none';
  stopTimer();
}

function loadStats() {
  const today = new Date().toDateString();
  const savedStats = localStorage.getItem('chem-stats');
  const savedDate = localStorage.getItem('chem-stats-date');
  if (savedDate === today && savedStats) stats = JSON.parse(savedStats);
  else {
    stats = { questionsToday: 0, correctToday: 0 };
    localStorage.setItem('chem-stats-date', today);
  }
  updateStatsDisplay();
}
function saveStats() { localStorage.setItem('chem-stats', JSON.stringify(stats)); }
function updateStatsDisplay() {
  document.getElementById('questionsToday').textContent = stats.questionsToday;
  document.getElementById('correctToday').textContent = stats.correctToday;
  const accuracy = stats.questionsToday > 0 ? Math.round((stats.correctToday / stats.questionsToday) * 100) : 0;
  document.getElementById('accuracy').textContent = accuracy + '%';
}
function resetStats() {
  if (confirm('Reset progress stats for today?')) {
    stats = { questionsToday: 0, correctToday: 0 };
    saveStats();
    updateStatsDisplay();
  }
}

function startTimer() {
  if (!document.getElementById('timerToggle').checked) return;
  timerSeconds = 0;
  document.getElementById('timerDisplay').style.display = 'block';
  updateTimerDisplay();
  timerInterval = setInterval(() => { timerSeconds++; updateTimerDisplay(); }, 1000);
}
function stopTimer() {
  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
}
function updateTimerDisplay() {
  const minutes = Math.floor(timerSeconds / 60);
  const seconds = timerSeconds % 60;
  document.getElementById('timerValue').textContent = `${minutes}:${String(seconds).padStart(2,'0')}`;
}

function pickOne(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
function randomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

function getReactionByDifficulty() {
  const p = getDifficultyProfile();
  const bag = [];
  p.reactionPools.forEach(k => bag.push(...reactionPools[k]));
  return pickOne(bag);
}

function parseFormula(formula) {
  let i = 0;
  function parseGroup() {
    const counts = {};
    while (i < formula.length) {
      const ch = formula[i];
      if (ch === '(') {
        i++;
        const inner = parseGroup();
        if (formula[i] !== ')') throw new Error('Unmatched "(" in formula: ' + formula);
        i++;
        const mult = parseNumber() || 1;
        for (const el in inner) counts[el] = (counts[el] || 0) + inner[el] * mult;
        continue;
      }
      if (ch === ')') break;
      const el = parseElement();
      const n = parseNumber() || 1;
      counts[el] = (counts[el] || 0) + n;
    }
    return counts;
  }
  function parseElement() {
    if (!/[A-Z]/.test(formula[i])) throw new Error('Bad element start in: ' + formula);
    let el = formula[i++];
    if (i < formula.length && /[a-z]/.test(formula[i])) el += formula[i++];
    return el;
  }
  function parseNumber() {
    let start = i;
    while (i < formula.length && /\d/.test(formula[i])) i++;
    if (start === i) return null;
    return parseInt(formula.slice(start, i), 10);
  }
  const result = parseGroup();
  if (i !== formula.length) throw new Error('Could not parse entire formula: ' + formula);
  return result;
}

function generateQuestions() {
  currentQuestions = [];
  const qc = document.getElementById('questionsContainer');
  const cb = document.getElementById('checkBtnContainer');
  const sc = document.getElementById('scoreContainer');
  qc.innerHTML = '';
  sc.style.display = 'none';

  const num = (practiceMode === 'practice') ? 5 : 10;
  for (let i = 0; i < num; i++) {
    let q;
    if (questionMode === 'stoichiometry') q = generateStoichiometryQuestion();
    else if (questionMode === 'balancing') q = generateBalancingQuestion();
    else if (questionMode === 'reaction') q = generateReactionTypeQuestion();
    else if (questionMode === 'molarMass') q = generateMolarMassQuestion();
    else q = generateAtomCountingQuestion();

    currentQuestions.push(q);

    const div = document.createElement('div');
    div.className = 'question';
    div.innerHTML = q.html;
    qc.appendChild(div);
  }
  qc.style.display = 'block';
  cb.style.display = 'block';
  if (practiceMode === 'practice') startTimer(); else stopTimer();
}

function generateStoichiometryQuestion() {
  const p = getDifficultyProfile();
  const reaction = getReactionByDifficulty();

  const givenCompound = pickOne(reaction.reactants);
  const findCompound = pickOne(reaction.products);

  const givenCoeff = parseFloat((givenCompound.match(/^(\d+)/) || [])[1] || 1);
  const findCoeff  = parseFloat((findCompound.match(/^(\d+)/) || [])[1] || 1);
  const givenFormula = givenCompound.replace(/^(\d+)/,'');
  const findFormula  = findCompound.replace(/^(\d+)/,'');

  let givenMoles;
  if (p.molesDecimals === 0) givenMoles = randomInt(1, p.molesMax);
  else givenMoles = Number(((Math.random() * (p.molesMax - 0.2)) + 0.2).toFixed(p.molesDecimals));

  const answer = Number((givenMoles * findCoeff / givenCoeff).toFixed(3));

  const idx = currentQuestions.length;
  const eqPlain = reaction.reactants.join(' + ') + ' â†’ ' + reaction.products.join(' + ');
  const eqHTML = formatEquationHTML(eqPlain);

  const html = `
    <div class="question-header">
      <div class="question-text">${idx + 1}. If you have ${givenMoles} moles of ${formatEquationHTML(givenFormula)}, how many moles of ${formatEquationHTML(findFormula)} can you make?</div>
      ${practiceMode === 'practice' ? `<button class="hint-button" onclick="toggleHint(${idx})">ðŸ’¡ Hint</button>` : ''}
    </div>
    ${practiceMode === 'practice' ? `
      <div class="hint-box" id="hint${idx}">
        <strong>Balanced Equation:</strong> ${eqHTML}<br>
        <strong>Given:</strong> ${givenMoles} mol ${formatEquationHTML(givenFormula)}<br>
        <strong>Find:</strong> mol ${formatEquationHTML(findFormula)}
      </div>` : ''}
    <div class="chemical-formula">${eqHTML}</div>
    <div class="answer-input">
      <input type="number" step="0.001" id="answer${idx}" placeholder="Answer">
      <span>moles of ${formatEquationHTML(findFormula)}</span>
    </div>
    <div class="feedback" id="feedback${idx}"></div>
  `;

  return { type:'stoichiometry', answer, steps: `${givenMoles} mol Ã— (${findCoeff}/${givenCoeff}) = ${answer} mol`, html };
}

function generateBalancingQuestion() {
  const reaction = getReactionByDifficulty();
  const idx = currentQuestions.length;

  const reactants = reaction.reactants.map(r => r.replace(/^(\d+)/,''));
  const products  = reaction.products.map(p => p.replace(/^(\d+)/,''));
  const correctCoeffs = reaction.reactants.concat(reaction.products).map(c => parseFloat((c.match(/^(\d+)/) || [])[1] || 1));
  const allCompounds = reactants.concat(products);

  const eqPlain = reactants.join(' + ') + ' â†’ ' + products.join(' + ');
  const eqHTML = formatEquationHTML(eqPlain);

  const html = `
    <div class="question-header">
      <div class="question-text">${idx + 1}. Balance this equation:</div>
      ${practiceMode === 'practice' ? `<button class="hint-button" onclick="toggleHint(${idx})">ðŸ’¡ Hint</button>` : ''}
    </div>
    ${practiceMode === 'practice' ? `
      <div class="hint-box" id="hint${idx}">
        <strong>Tip:</strong> Count atoms on each side.<br>
        <strong>Strategy:</strong> Start with the most complex compound.
      </div>` : ''}
    <div class="chemical-formula">${eqHTML}</div>
    <div class="answer-input">
      ${allCompounds.map((c, i) => `
        <div class="coefficient-input">
          <input type="number" min="1" step="1" id="coeff${idx}_${i}" placeholder="?" />
          <span>${formatEquationHTML(c)}</span>
          ${i === reactants.length - 1 ? '<span style="margin:0 10px;">â†’</span>' : (i < allCompounds.length - 1 ? '<span style="margin:0 5px;">+</span>' : '')}
        </div>
      `).join('')}
    </div>
    <div class="feedback" id="feedback${idx}"></div>
  `;

  return { type:'balancing', answer: correctCoeffs, numCompounds: allCompounds.length,
           steps: `Correct coefficients: ${reaction.reactants.join(' + ')} â†’ ${reaction.products.join(' + ')}`, html };
}

function normalizeType(t) {
  const base = String(t).toLowerCase().trim().replace(/[-_]+/g,' ').replace(/\s+/g,' ');
  const set = new Set([base]);
  if (base === 'single replacement') set.add('single replacement');
  if (base === 'double replacement') set.add('double replacement');
  return set;
}

function generateReactionTypeQuestion() {
  const reaction = getReactionByDifficulty();
  const idx = currentQuestions.length;

  const reactants = reaction.reactants.map(r => r.replace(/^(\d+)/,''));
  const products  = reaction.products.map(p => p.replace(/^(\d+)/,''));
  const correctCoeffs = reaction.reactants.concat(reaction.products).map(c => parseFloat((c.match(/^(\d+)/) || [])[1] || 1));
  const allCompounds = reactants.concat(products);

  const eqPlain = reactants.join(' + ') + ' â†’ ' + products.join(' + ');
  const eqHTML = formatEquationHTML(eqPlain);

  const html = `
    <div class="question-header">
      <div class="question-text">${idx + 1}. Balance this equation AND identify the reaction type:</div>
    </div>
    <div class="chemical-formula">${eqHTML}</div>
    <div class="answer-input">
      ${allCompounds.map((c, i) => `
        <div class="coefficient-input">
          <input type="number" min="1" step="1" id="coeff${idx}_${i}" placeholder="?" />
          <span>${formatEquationHTML(c)}</span>
          ${i === reactants.length - 1 ? '<span style="margin:0 10px;">â†’</span>' : (i < allCompounds.length - 1 ? '<span style="margin:0 5px;">+</span>' : '')}
        </div>
      `).join('')}
    </div>
    <div style="margin-top:12px;">
      <label>Reaction Type:</label>
      <input type="text" id="reactionType${idx}" placeholder="e.g., synthesis" />
    </div>
    <div class="feedback" id="feedback${idx}"></div>
  `;

  return { type:'reaction', answer: correctCoeffs, reactionType: normalizeType(reaction.type),
           numCompounds: allCompounds.length,
           steps: `Correct: ${reaction.reactants.join(' + ')} â†’ ${reaction.products.join(' + ')} (${reaction.type})`, html };
}

function generateMolarMassQuestion() {
  const p = getDifficultyProfile();
  const pool = formulaPools[p.formulaPool] || formulaPools.medium;
  const formula = pickOne(pool);

  const parsed = parseFormula(formula);
  let totalMass = 0;
  for (const el in parsed) {
    if (!atomicMasses[el]) throw new Error('Missing atomic mass for ' + el);
    totalMass += atomicMasses[el] * parsed[el];
  }
  const answer = Number(totalMass.toFixed(p.mmDecimals));

  const idx = currentQuestions.length;
  const html = `
    <div class="question-header">
      <div class="question-text">${idx + 1}. What is the molar mass of ${formatEquationHTML(formula)}?</div>
    </div>
    <div class="chemical-formula">${formatEquationHTML(formula)}</div>
    <div class="answer-input">
      <input type="number" step="${p.mmDecimals === 1 ? '0.1' : '0.01'}" id="answer${idx}" placeholder="Answer">
      <span>g/mol</span>
    </div>
    <div class="feedback" id="feedback${idx}"></div>
  `;
  return { type:'molarMass', answer, tolerance: p.mmTolerance, steps: `Molar mass = ${answer} g/mol`, html };
}

function generateAtomCountingQuestion() {
  const p = getDifficultyProfile();
  const pool = formulaPools[p.formulaPool] || formulaPools.medium;
  const formula = pickOne(pool);
  const parsed = parseFormula(formula);
  const elements = Object.keys(parsed);

  const askTotal = Math.random() < p.atomAskTotalChance;
  const multiplier = randomInt(1, p.atomMaxMultiplier);

  let correct, prompt;
  if (askTotal) {
    const totalAtomsOne = elements.reduce((sum, el) => sum + parsed[el], 0);
    correct = totalAtomsOne * multiplier;
    prompt = `How many total atoms are in ${multiplier === 1 ? '' : (multiplier + ' Ã— ')}${formula}?`;
  } else {
    const element = pickOne(elements);
    correct = parsed[element] * multiplier;
    prompt = `How many ${element} atoms are in ${multiplier === 1 ? '' : (multiplier + ' Ã— ')}${formula}?`;
  }

  const idx = currentQuestions.length;
  const html = `
    <div class="question-header">
      <div class="question-text">${idx + 1}. ${escapeHtml(prompt)}</div>
    </div>
    <div class="chemical-formula">${multiplier === 1 ? formatEquationHTML(formula) : (multiplier + ' Ã— ' + formatEquationHTML(formula))}</div>
    <div class="answer-input">
      <input type="number" step="1" id="answer${idx}" placeholder="Answer">
      <span>atoms</span>
    </div>
    <div class="feedback" id="feedback${idx}"></div>
  `;
  return { type:'atoms', answer: correct, steps: `Correct answer: ${correct}`, html };
}

function toggleHint(index) {
  const box = document.getElementById('hint' + index);
  if (box) box.classList.toggle('show');
}

function markCorrect(el) {
  el.className = 'feedback correct';
  el.textContent = 'âœ“ Correct!';
}
function markIncorrect(el, details) {
  el.className = 'feedback incorrect';
  el.innerHTML = `âœ— Incorrect.<br>${escapeHtml(details)}`;
}

function checkAnswers() {
  const p = getDifficultyProfile();
  let correct = 0;
  stopTimer();

  currentQuestions.forEach((q, i) => {
    const feedback = document.getElementById('feedback' + i);
    stats.questionsToday++;

    if (q.type === 'stoichiometry') {
      const userAnswer = parseFloat(document.getElementById('answer' + i).value);
      if (!isNaN(userAnswer) && Math.abs(userAnswer - q.answer) < 0.01) {
        markCorrect(feedback); correct++; stats.correctToday++;
      } else {
        markIncorrect(feedback, q.steps);
      }
    }
    else if (q.type === 'molarMass') {
      const userAnswer = parseFloat(document.getElementById('answer' + i).value);
      const tol = q.tolerance ?? p.mmTolerance;
      if (!isNaN(userAnswer) && Math.abs(userAnswer - q.answer) <= tol) {
        markCorrect(feedback); correct++; stats.correctToday++;
      } else {
        markIncorrect(feedback, q.steps + ` (Acceptable Â±${tol})`);
      }
    }
    else if (q.type === 'atoms') {
      const userAnswer = parseInt(document.getElementById('answer' + i).value, 10);
      if (!isNaN(userAnswer) && userAnswer === q.answer) {
        markCorrect(feedback); correct++; stats.correctToday++;
      } else {
        markIncorrect(feedback, q.steps);
      }
    }
    else if (q.type === 'balancing' || q.type === 'reaction') {
      const userCoeffs = [];
      let valid = true;
      for (let j = 0; j < q.numCompounds; j++) {
        const val = parseInt(document.getElementById(`coeff${i}_${j}`).value, 10);
        if (isNaN(val) || val < 1) { valid = false; break; }
        userCoeffs.push(val);
      }
      const coeffsCorrect = JSON.stringify(userCoeffs) === JSON.stringify(q.answer);

      let typeCorrect = true;
      if (q.type === 'reaction') {
        const raw = (document.getElementById('reactionType' + i).value || '')
          .toLowerCase().trim().replace(/[-_]+/g,' ').replace(/\s+/g,' ');
        typeCorrect = q.reactionType.has(raw);
      }

      if (valid && coeffsCorrect && typeCorrect) {
        markCorrect(feedback); correct++; stats.correctToday++;
      } else {
        markIncorrect(feedback, q.steps);
      }
    }
  });

  saveStats();
  updateStatsDisplay();

  const total = (practiceMode === 'practice') ? 5 : 10;
  document.getElementById('score').textContent = `${correct} / ${total}`;
  document.getElementById('scoreContainer').style.display = 'block';
}

(function init() {
  setActiveButton('stoichBtn', ['stoichBtn','balanceBtn','reactionBtn','molarMassBtn','atomsBtn']);
  setActiveButton('practiceModeBtn', ['practiceModeBtn','worksheetModeBtn']);
  updateDifficultyNote();
  loadStats();
})();
</script>

<script>
/* ===== OVERRIDES: Formatting + Reaction Types Fix ===== */

function formatChemHTML(str) {
  const escaped = escapeHtml(str);
  const withCoeffSpace = escaped.replace(/(^|[\s\+â†’])(\d+)(?=[A-Z(])/g, '$1$2&nbsp;');
  return withCoeffSpace.replace(/([A-Za-z\)])(\d+)/g, '$1<sub>$2</sub>');
}

function markIncorrect(el, details) {
  el.className = 'feedback incorrect';
  el.innerHTML = `âœ— Incorrect.<br>${formatChemHTML(details)}`;
}

const REACTION_TYPE_CHOICES = [
  'synthesis',
  'decomposition',
  'single replacement',
  'double replacement',
  'combustion'
];

function titleCase(s) {
  return s.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
}

function generateReactionTypeQuestion() {
  const reaction = getReactionByDifficulty();
  const idx = currentQuestions.length;

  const reactants = reaction.reactants.map(r => r.replace(/^(\d+)/,''));
  const products  = reaction.products.map(p => p.replace(/^(\d+)/,''));

  const eqPlain = reactants.join(' + ') + ' â†’ ' + products.join(' + ');
  const eqHTML  = formatChemHTML(eqPlain);

  const choices = shuffle([...REACTION_TYPE_CHOICES]);

  const html = `
    <div class="question-header">
      <div class="question-text">${idx + 1}. Identify the reaction type:</div>
    </div>
    <div class="chemical-formula">${eqHTML}</div>
    <div style="margin-top:12px;">
      ${choices.map((t) => `
        <label style="display:block; margin:6px 0;">
          <input type="radio" name="rtype${idx}" value="${t}" />
          ${titleCase(t)}
        </label>
      `).join('')}
    </div>
    <div class="feedback" id="feedback${idx}"></div>
  `;

  return {
    type: 'reaction',
    reactionType: normalizeType(reaction.type),
    steps: `Correct type: ${reaction.type}. Example: ${reaction.reactants.join(' + ')} â†’ ${reaction.products.join(' + ')}`,
    html
  };
}

/* Patch checkAnswers for reaction-only grading */
const originalCheckAnswers = checkAnswers;
checkAnswers = function() {
  let correct = 0;

  currentQuestions.forEach((q, i) => {
    const feedback = document.getElementById(`feedback${i}`);

    if (q.type === 'reaction') {
      const picked = document.querySelector(`input[name="rtype${i}"]:checked`);
      const raw = (picked ? picked.value : '')
        .toLowerCase().trim().replace(/[-_]+/g,' ').replace(/\s+/g,' ');
      const typeCorrect = q.reactionType.has(raw);

      if (typeCorrect) {
        markCorrect(feedback); correct++; stats.correctToday++;
      } else {
        markIncorrect(feedback, q.steps);
      }
    }
  });

  originalCheckAnswers();
};
</script>

</body>
</html>
